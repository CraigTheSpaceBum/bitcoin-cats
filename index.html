<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Bitcoin Cats</title>
  <meta name="description" content="Personal blog powered by Nostr (read-only feed).">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-overlay: rgba(0,0,0,0.6);
      --text:#f3f3f6;
      --muted:#b0b0ba;
      --border:#2c2c3c;
      --orange:#ffa447;
      --orange-2:#ff7a1a;
      --card-bg: rgba(20,20,28,0.65);
      --quote-bg: rgba(40,40,52,0.5);
      --shadow: 0 6px 20px rgba(0,0,0,0.45);
      --play-bg: rgba(0,0,0,0.5);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;scroll-behavior:smooth;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    body{
      color:var(--text);
      background: var(--bg-overlay) url('https://bitcoin-cats.ca/BackgroundLoop.webp') center center / cover no-repeat fixed;
      background-blend-mode: darken;
      overflow-x:hidden;
    }
    a{color:#ffd099;text-decoration:none}
    a:hover{text-decoration:underline}
    .container{max-width:1680px;margin:0 auto;padding:20px}

    /* NEW: Banner */
    header.profile{
      position:relative;
      margin:30px 0 30px 0;
      animation:fadeIn 1.5s ease;
    }
    .banner{
      position:relative;
      width:100%;
      border:1px solid rgba(255,180,120,0.25);
      background:
        linear-gradient(90deg, rgba(255,164,71,0.35), rgba(255,122,26,0.20) 45%, rgba(255,164,71,0.18));
      backdrop-filter: blur(4px);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:22px 22px 22px 120px; /* space for overlapping pfp */
      min-height:120px;
      overflow:visible;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:20px;
    }
    .pfp-wrap{
      position:absolute;
      left:-28px; top:50%;
      transform:translateY(-50%);
      width:140px; height:140px;
    }
    .pfp-wrap img{
      width:140px; height:140px; border-radius:50%;
      object-fit:cover;
      border:4px solid rgba(255,164,71,0.6);
      box-shadow:0 10px 30px rgba(0,0,0,0.55);
    }
    .id-block{
      display:flex; flex-direction:column; gap:8px;
    }
    .id-name{
      font-size:1.9rem; font-weight:900; color:#ffe0c2; text-shadow:0 2px 10px rgba(0,0,0,0.35);
    }
    .id-npub{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size:0.95rem; color:#ffe0c2; opacity:0.85;
      background:rgba(0,0,0,0.25);
      border:1px solid rgba(255,200,150,0.25);
      padding:4px 10px; border-radius:999px;
      max-width:100%;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .actions{
      margin-left:auto;
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .btn{
      border:1px solid rgba(255,200,150,0.25);
      background:linear-gradient(180deg, rgba(25,18,12,0.8), rgba(20,14,10,0.8));
      color:#ffd9b3;
      padding:9px 14px; border-radius:999px; font-weight:800; cursor:pointer;
      box-shadow:var(--shadow);
      transition:transform .08s ease, filter .15s ease;
      user-select:none;
    }
    .btn:hover{filter:brightness(1.12)}
    .btn:active{transform:scale(0.98)}
    .btn.ghost{background:transparent}
    .followers-badge{
      display:inline-flex; align-items:center; gap:6px;
    }

    /* Loading overlay */
    .loading-overlay{
      position:fixed; inset:0; display:grid; place-items:center; z-index:99;
      background: radial-gradient(800px 400px at 20% -10%, rgba(255,122,26,0.12), transparent 60%) no-repeat,
                  radial-gradient(900px 500px at 110% 120%, rgba(255,164,71,0.10), transparent 60%) no-repeat,
                  rgba(5,5,8,0.9);
      transition: opacity .6s ease, visibility .6s ease;
    }
    .loading-overlay.hidden{opacity:0; visibility:hidden;}
    .loading-text{
      font-family: "Press Start 2P", monospace;
      color:#ffb77a; letter-spacing: 1px; text-shadow: 0 0 10px rgba(255,122,26,0.5);
      animation: flicker 1.3s infinite;
    }
    @keyframes flicker{0%,100%{opacity:1}50%{opacity:0.55}}

    main.feed{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
      gap:24px;
      padding-bottom:100px;
    }
    article.post{
      background:var(--card-bg);
      border:1px solid var(--border);
      border-radius:18px;
      padding:18px;
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      min-height:480px;
      opacity:0;
      transform:translateY(20px);
      transition:opacity 0.8s ease, transform 0.8s ease;
    }
    article.post.visible{opacity:1;transform:translateY(0)}
    .post-header{display:flex;align-items:center;gap:12px;margin-bottom:8px}
    .pfp{width:48px;height:48px;border-radius:50%;object-fit:cover;border:1px solid var(--border)}
    .post-meta{display:flex;flex-direction:column}
    .name{font-weight:800;color:var(--orange)}
    .time{font-size:13px;color:var(--muted)}
    .content{
      white-space:pre-wrap;
      font-size:15px;line-height:1.55;margin-top:4px;
      /* NEW: keep super-long tokens from breaking the card */
      overflow-wrap:anywhere;
      word-break:break-word;
    }
    .gallery{margin-top:6px;display:flex;gap:10px;overflow-x:auto;padding-bottom:6px;flex:1;min-height:160px}
    .gallery.single{min-height:0; height:100%;}
    .gallery::-webkit-scrollbar{height:8px}
    .gallery::-webkit-scrollbar-thumb{background:#333;border-radius:999px}
    .media-box{
      background:#0b0b12; border:1px solid var(--border); border-radius:12px;
      display:flex; align-items:center; justify-content:center;
      min-width:260px; max-width:100%; height:220px; flex-shrink:0; position:relative; overflow:hidden;
    }
    .gallery.single .media-box{height:100%; min-width:0; width:100%}
    .media-box img{max-height:100%; max-width:100%; object-fit:contain; display:block}
    .play-overlay{
      position:absolute; inset:0; display:grid; place-items:center; background:var(--play-bg);
      opacity:1; transition:opacity .2s ease; cursor:pointer;
      font-weight:800; color:#ffd9b3; border:1px dashed rgba(255,255,255,0.15);
    }
    .play-overlay:hover{opacity:1}
    .quote{
      background:var(--quote-bg);
      border-left:3px solid var(--orange);
      border-radius:12px;
      padding:10px 14px;
      margin-top:10px;
    }
    .quote-header{display:flex;align-items:center;gap:10px;margin-bottom:6px}
    .quote-header img{width:24px;height:24px;border-radius:50%;object-fit:cover;border:1px solid var(--border)}
    .quote-name{font-size:13px;font-weight:700;color:var(--orange)}
    .quote-text{font-size:14px;color:var(--muted);white-space:pre-wrap;line-height:1.4;}
    .mention{
      display:inline-flex; align-items:center; gap:6px; padding:2px 6px; border-radius:999px;
      background: rgba(255,164,71,0.08); border:1px solid rgba(255,164,71,0.25);
      margin:0 2px; opacity:0; transform:translateY(4px);
      transition:opacity .4s ease, transform .4s ease;
      /* NEW: never let badges overflow */
      max-width:220px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      vertical-align:middle;
    }
    .mention.visible{opacity:1; transform:translateY(0);}
    .mention img{width:20px;height:20px;border-radius:50%;object-fit:cover;border:1px solid var(--border)}
    .mention .label{
      color:var(--orange); font-weight:700; font-size:13px;
      /* NEW: clamp the text inside the badge */
      max-width:170px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      display:inline-block;
    }
    footer{color:var(--muted);font-size:12px;text-align:center;padding:40px 0}
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
  
    .about-page {
      animation: fadeIn 0.8s ease forwards;
      border-radius: 0;
      padding: 10px;
      box-shadow: none;
      border: none;
      color: var(--text);
      min-height: 10vh;
    }

    .about-page.hidden {
      opacity: 0;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <center>
        <div class="loading-text">LOADING‚Ä¶</div>
        <img src="catstr.gif" alt="Loading Cat" class="loading-cat">
      </center>
    </div>
  </div>

  <div class="container">
    <header class="profile" id="profileHeader">
      <div class="banner">
        <div class="pfp-wrap">
          <img id="pfp" alt="Profile Picture">
        </div>
        <div class="id-block">
          <div class="id-name" id="profName">Loading‚Ä¶</div>
          <div class="id-npub" id="profNpub">npub‚Ä¶</div>
        </div>
        <div class="actions">
          <button class="btn" id="homeBtn">üè† Blog</button>
          <button class="btn" id="aboutBtn">‚ÑπÔ∏è About</button>
          <button class="btn" id="zapBtn">‚ö° Zap</button>
          <button class="btn ghost" id="shopBtn">üõí Shop</button>
          <button class="btn" id="followBtn">
            <span class="followers-badge">üë• Follow <span id="followersCount"></span></span>
          </button>
        </div>
      </div>
    </header>

    <main class="feed" id="feed"></main>
  </div>

<script>
const API = "https://api.nostr.wine/search";
const PUBKEY_HEX = "3ab4c8ea97cd164d17f68990c1006e21e87f31a919a7013ecf2dae2e416938fd";
const DEFAULT_LIMIT = 100;
const feedEl = document.getElementById("feed");
const overlay = document.getElementById("loadingOverlay");

/* ---------- Utils ---------- */
function humanTime(ts){return new Date(ts*1000).toLocaleString();}
function linkify(text){
  const urlRe=/(https?:\/\/[^\s]+)/g;
  return text.replace(urlRe,(u)=>`<a href="${u}" target="_blank" rel="noopener noreferrer">${u}</a>`);
}
function extractImages(text){
  const imgRe=/(https?:\/\/[^\s]+\.(jpg|jpeg|png|gif|webp))/gi;
  return [...text.matchAll(imgRe)].map(m=>m[0]);
}
function extractVideos(text){
  const vidRe=/(https?:\/\/[^\s]+\.(mp4|webm|mov))/gi;
  return [...text.matchAll(vidRe)].map(m=>m[0]);
}
function extractLive(text){
  const list = [];
  const urlRe=/(https?:\/\/[^\s]+)/g;
  (text.match(urlRe)||[]).forEach(u=>{
    if(u.includes("zap.stream") || u.includes("nostr.build/live")) list.push(u);
  });
  return list;
}
function findNevent(text){
  const m = text.match(/nostr:nevent1[0-9a-z]+/i);
  return m ? m[0] : null;
}
function findAllNprofiles(text){
  return text.match(/nostr:nprofile1[0-9a-z]+/ig) || [];
}
function stripMediaAndNevent(text){
  let t = text.replace(/https?:\/\/[^\s]+\.(jpg|jpeg|png|gif|webp|mp4|webm|mov)/gi, '');
  t = t.replace(/https?:\/\/(?:zap\.stream|nostr\.build\/live)[^\s]*/gi, '');
  t = t.replace(/nostr:nevent1[0-9a-z]+/ig, '');
  return t.trim();
}

/* ---------- Bech32 encode/decode & helpers ---------- */
const CHARSET="qpzry9x8gf2tvdw0s3jn54khce6mua7l";
function bech32Polymod(values){const GEN=[0x3b6a57b2,0x26508e6d,0x1ea119fa,0x3d4233dd,0x2a1462b3];let chk=1;for(const v of values){const b=chk>>25;chk=((chk&0x1ffffff)<<5)^v;for(let i=0;i<5;i++) if((b>>i)&1) chk^=GEN[i];}return chk;}
function hrpExpand(hrp){const ret=[];for(let i=0;i<hrp.length;i++) ret.push(hrp.charCodeAt(i)>>5);ret.push(0);for(let i=0;i<hrp.length;i++) ret.push(hrp.charCodeAt(i)&31);return ret;}
function createChecksum(hrp,data){let values=hrpExpand(hrp).concat(data);values=values.concat([0,0,0,0,0,0]);const mod=bech32Polymod(values)^1;const ret=[];for(let p=0;p<6;p++) ret.push((mod>>(5*(5-p)))&31);return ret;}
function verifyChecksum(hrp,data){return bech32Polymod(hrpExpand(hrp).concat(data))===1;}
function bech32Decode(str){const s=str.trim().toLowerCase();const pos=s.lastIndexOf("1");if(pos<1) return null;const hrp=s.slice(0,pos);const data=[];for(let i=pos+1;i<s.length;i++){const v=CHARSET.indexOf(s[i]);if(v===-1) return null;data.push(v);}if(!verifyChecksum(hrp,data)) return null;return {hrp, words:data.slice(0,-6)};}
function bech32Encode(hrp, words){const chk = createChecksum(hrp, words); const data = words.concat(chk); return hrp + "1" + data.map(v=>CHARSET[v]).join("");}
function convertBits(data,fromBits,toBits,pad=true){let acc=0,bits=0;const ret=[];const maxv=(1<<toBits)-1;for(const value of data){if(value<0||(value>>fromBits)) return null;acc=(acc<<fromBits)|value;bits+=fromBits;while(bits>=toBits){bits-=toBits;ret.push((acc>>bits)&maxv);}}if(pad&&bits) ret.push((acc<<(toBits-bits))&maxv);return ret;}
function hexToBytes(hex){const out=new Uint8Array(hex.length/2);for(let i=0;i<out.length;i++) out[i]=parseInt(hex.substr(i*2,2),16);return out;}
function pubkeyToNpub(hex){
  const data = convertBits(Array.from(hexToBytes(hex)),8,5,true);
  return bech32Encode("npub", data);
}

/* ---------- TLV helpers for nevent/nprofile ---------- */
function neventToId(nevent){
  try{
    const dec=bech32Decode(nevent);
    if(!dec || dec.hrp!=="nevent") return null;
    const bytes = new Uint8Array(convertBits(dec.words,5,8,false));
    for(let i=0;i<bytes.length;){
      const t=bytes[i++]; const l=bytes[i++]; const v=bytes.slice(i, i+l); i+=l;
      if(t===1 && l===32){
        return Array.from(v).map(b=>b.toString(16).padStart(2,'0')).join('');
      }
    }
  }catch{}
  return null;
}
function nprofileToPubkey(nprofile){
  try{
    const dec=bech32Decode(nprofile);
    if(!dec || dec.hrp!=="nprofile") return null;
    const bytes = new Uint8Array(convertBits(dec.words,5,8,false));
    for(let i=0;i<bytes.length;){
      const t=bytes[i++]; const l=bytes[i++]; const v=bytes.slice(i, i+l); i+=l;
      if(t===0 && l===32){
        return Array.from(v).map(b=>b.toString(16).padStart(2,'0')).join('');
      }
    }
  }catch{}
  return null;
}

/* ---------- API helpers ---------- */
async function getNoteById(idHex){
  const url = `${API}?id=${idHex}`;
  const r = await fetch(url,{mode:"cors"});
  if(!r.ok) return null;
  const j = await r.json();
  return (j && (j.data?.[0]||j[0]))||null;
}
async function getProfile(pubkeyHex){
  const url=`${API}?pubkey=${pubkeyHex}&kind=0&sort=time&order=descending&limit=1`;
  const r=await fetch(url,{mode:"cors"});
  if(!r.ok) return {name: shortKey(pubkeyHex), picture:"https://api.dicebear.com/7.x/identicon/svg?seed="+pubkeyHex};
  const j=await r.json();
  const ev=(j && (j.data?.[0]||j[0]))||null;
  if(!ev) return {name: shortKey(pubkeyHex), picture:"https://api.dicebear.com/7.x/identicon/svg?seed="+pubkeyHex};
  let meta={};
  try{meta=JSON.parse(ev.content||"{}");}catch{}
  return {
    name: meta.display_name || meta.name || shortKey(pubkeyHex),
    picture: meta.picture || "https://api.dicebear.com/7.x/identicon/svg?seed="+pubkeyHex,
    lud16: meta.lud16 || "",
    lud06: meta.lud06 || ""
  };
}
function shortKey(k){return k.slice(0,8)+"‚Ä¶"+k.slice(-4);}

async function getKind0(pubkeyHex){
  const url=`${API}?pubkey=${pubkeyHex}&kind=0&sort=time&order=descending&limit=1`;
  const r=await fetch(url,{mode:"cors"});
  if(!r.ok) return null;
  const j=await r.json();
  return (j && (j.data?.[0]||j[0]))||null;
}
async function getKind1(pubkeyHex){
  const url=`${API}?pubkey=${pubkeyHex}&kind=1&sort=time&order=descending&limit=${DEFAULT_LIMIT}`;
  const r=await fetch(url,{mode:"cors"});
  if(!r.ok) return [];
  const j=await r.json();
  return j?.data||[];
}

/* ---------- Followers count (best-effort) ---------- */
async function getFollowersCount(pubkeyHex){
  try{
    const try1 = await fetch(`${API}?kind=3&tag=p&value=${pubkeyHex}&count=true&limit=1`, {mode:"cors"});
    if(try1.ok){
      const j = await try1.json();
      if(typeof j.count === "number") return j.count;
      if(Array.isArray(j.data)) return j.data.length;
    }
    const try2 = await fetch(`${API}?kind=3&search=${pubkeyHex}&limit=100`, {mode:"cors"});
    if(try2.ok){
      const j = await try2.json();
      if(Array.isArray(j.data)) return j.data.length;
    }
  }catch(e){}
  return null;
}

/* ---------- Media helpers ---------- */
function mediaBoxForImage(src){
  const box=document.createElement("div"); box.className="media-box";
  const img=document.createElement("img"); img.src=src; img.alt="image";
  img.onclick=()=>window.open(src,"_blank");
  box.appendChild(img);
  return box;
}
function mediaBoxForVideo(src){
  const box=document.createElement("div"); box.className="media-box";
  const overlay=document.createElement("div"); overlay.className="play-overlay"; overlay.textContent="‚ñ∂ CLICK TO PLAY";
  overlay.onclick=()=>{
    box.removeChild(overlay);
    const v=document.createElement("video");
    v.src=src; v.controls=true; v.playsInline=true; v.preload="none";
    v.style.maxHeight="100%"; v.style.maxWidth="100%";
    box.appendChild(v);
    v.focus();
  };
  box.appendChild(overlay);
  return box;
}
function mediaBoxForLive(url){
  const box=document.createElement("div"); box.className="media-box";
  const overlay=document.createElement("div"); overlay.className="play-overlay"; overlay.textContent="‚ñ∂ CLICK TO OPEN STREAM";
  overlay.onclick=()=>{
    box.removeChild(overlay);
    const f=document.createElement("iframe");
    f.allow="accelerometer; encrypted-media; picture-in-picture; fullscreen";
    f.style.width="100%"; f.style.height="100%"; f.frameBorder="0";
    f.src=url;
    box.appendChild(f);
  };
  box.appendChild(overlay);
  return box;
}

/* ---------- Mentions (fixed & robust) ---------- */
async function replaceNprofileMentions(container){
  const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT);
  const nodes = [];
  while (walker.nextNode()) nodes.push(walker.currentNode);

  for (const node of nodes) {
    const text = node.textContent;
    const matches = findAllNprofiles(text);
    if (!matches.length) continue;

    const frag = document.createDocumentFragment();
    let lastIndex = 0;

    for (const token of matches) {
      const index = text.indexOf(token, lastIndex);
      if (index > lastIndex) {
        frag.appendChild(document.createTextNode(text.slice(lastIndex, index)));
      }

      const placeholder = document.createElement("span");
      placeholder.className = "mention";
      placeholder.textContent = "‚Ä¶";
      frag.appendChild(placeholder);

      (async () => {
        const pubkey = nprofileToPubkey(token);
        const profile = pubkey
          ? await getProfile(pubkey)
          : {name: token, picture:"https://api.dicebear.com/7.x/identicon/svg?seed=p"};

        const a = document.createElement("a");
        a.href = "https://njump.me/" + token;
        a.target = "_blank"; a.rel="noopener noreferrer";
        a.className = "mention visible";

        const img = document.createElement("img"); img.src = profile.picture; img.alt = profile.name;
        const label = document.createElement("span"); label.className="label"; label.textContent = profile.name;

        a.appendChild(img); a.appendChild(label);
        placeholder.replaceWith(a);
      })();

      lastIndex = index + token.length;
    }

    if (lastIndex < text.length) {
      frag.appendChild(document.createTextNode(text.slice(lastIndex)));
    }

    node.parentNode.replaceChild(frag, node);
  }
}

/* ---------- Feed ---------- */
async function drawFeed(events){
  feedEl.innerHTML="";
  if(!events?.length){
    feedEl.innerHTML="<p style='color:var(--muted);text-align:center;'>No posts found.</p>";
    overlay.classList.add("hidden");
    return;
  }
  for(const ev of events){
    if(ev.tags && ev.tags.some(t=>t[0]==="e")) continue;

    const post=document.createElement("article");
    post.className="post";

    const header=document.createElement("div"); header.className="post-header";
    const pfp=document.createElement("img"); pfp.className="pfp"; pfp.src=document.getElementById("pfp").src;
    const metaDiv=document.createElement("div"); metaDiv.className="post-meta";
    const name=document.createElement("div"); name.className="name"; name.textContent=document.getElementById("profName").textContent;
    const time=document.createElement("div"); time.className="time"; time.textContent=humanTime(ev.created_at);
    metaDiv.appendChild(name); metaDiv.appendChild(time);
    header.appendChild(pfp); header.appendChild(metaDiv);

    const content=document.createElement("div"); content.className="content";
    const textOnly = stripMediaAndNevent(ev.content||"");
    content.innerHTML = linkify(textOnly);
    await replaceNprofileMentions(content);

    const gallery=document.createElement("div"); gallery.className="gallery";
    const imgs=extractImages(ev.content||"");
    const vids=extractVideos(ev.content||"");
    const lives=extractLive(ev.content||"");

    imgs.forEach(u=> gallery.appendChild(mediaBoxForImage(u)));
    vids.forEach(u=> gallery.appendChild(mediaBoxForVideo(u)));
    lives.forEach(u=> gallery.appendChild(mediaBoxForLive(u)));

    if(gallery.childNodes.length === 1) gallery.classList.add("single");

    post.appendChild(header);
    post.appendChild(content);
    if(gallery.childNodes.length) post.appendChild(gallery);

    const nevent = findNevent(ev.content||"");
    if(nevent){
      const idHex = neventToId(nevent);
      if(idHex){
        try{
          const quoted = await getNoteById(idHex);
          if(quoted){
            const qProfile = await getProfile(quoted.pubkey);
            const quoteDiv=document.createElement("div"); quoteDiv.className="quote";
            const qh=document.createElement("div"); qh.className="quote-header";
            const qp=document.createElement("img"); qp.src=qProfile.picture;
            const qname=document.createElement("div"); qname.className="quote-name"; qname.textContent=qProfile.name;
            qh.appendChild(qp); qh.appendChild(qname);
            const qt=document.createElement("div"); qt.className="quote-text"; qt.textContent=(quoted.content||"").slice(0,500);
            quoteDiv.appendChild(qh); quoteDiv.appendChild(qt);
            post.appendChild(quoteDiv);
          }
        }catch(e){ console.warn("Failed to render nevent quote", e); }
      }
    }

    feedEl.appendChild(post);
  }

  setupFadeIn();
  overlay.classList.add("hidden");
}
function setupFadeIn(){
  const observer=new IntersectionObserver(entries=>{
    entries.forEach(entry=>{
      if(entry.isIntersecting) entry.target.classList.add("visible");
      else entry.target.classList.remove("visible");
    });
  },{threshold:0.2});
  document.querySelectorAll(".post").forEach(el=>observer.observe(el));
}

/* ---------- Page wiring ---------- */
function applyProfileToBanner(meta){
  document.getElementById("pfp").src = meta.picture;
  document.getElementById("profName").textContent = meta.name;
  document.getElementById("profNpub").textContent = pubkeyToNpub(PUBKEY_HEX);
}

/* Zap any amount (currently unused, kept for future) */
async function zapAnyAmount(lud){
  if(!lud){
    alert("No Lightning address set on this profile.");
    return;
  }
  const input = prompt("Enter the amount to zap (in sats):", "1000");
  if(!input) return;
  const sats = parseInt(input, 10);
  if(isNaN(sats) || sats <= 0){ alert("Invalid amount."); return; }
  const msats = sats * 1000;
  const target = `lightning:${lud}${lud.includes('?') ? '&' : '?'}amount=${msats}`;
  window.location.href = target;
}

/* About page */
async function showAbout() {
  try {
    overlay.classList.remove("hidden");
    const r = await fetch("about.html", { mode: "cors" });
    const html = r.ok
      ? await r.text()
      : "<p style='color:#f77'>about.html not found.</p>";

    // Clear the grid and inject a full-screen content div
    feedEl.innerHTML = `
      <div id="aboutPage" class="about-page hidden">${html}</div>
    `;

    // Trigger fade-in
    setTimeout(() => {
      const aboutPage = document.getElementById("aboutPage");
      aboutPage.classList.remove("hidden");
    }, 50);
  } finally {
    overlay.classList.add("hidden");
  }
}

/* Zap page (BTCPay app in iframe, same style as About) */
async function showZapPage() {
  try {
    overlay.classList.remove("hidden");

    const zapHTML = `
      <center>
        <h2 style="margin:20px 0; color:#ffd099;">‚ö° Support Bitcoin Cats</h2>
      </center>
      <iframe
        src="https://zap.bitcoin-cats.ca/api/v1/invoices?storeId=5QQaqAEokikzshLH8UHJkGFv5BCc6GArbLq9NvQbuYVb&currency=CAD"
        style="
          width:100%;
          height:80vh;
          border:none;
          border-radius:16px;
          box-shadow:0 0 20px rgba(0,0,0,0.5);
          background:#000;
        ">
      </iframe>
    `;

    feedEl.innerHTML = `
      <div id="zapPage" class="about-page hidden">${zapHTML}</div>
    `;

    setTimeout(() => {
      const zapPage = document.getElementById("zapPage");
      zapPage.classList.remove("hidden");
    }, 50);
  } finally {
    overlay.classList.add("hidden");
  }
}

/* Follow via extension */
async function followViaExtension(){
  try{
    if(!window.nostr){
      alert("A Nostr extension is required to follow. Please install Alby, nos2x, or similar.");
      return;
    }
    const ev = {
      kind: 3,
      created_at: Math.floor(Date.now()/1000),
      tags: [["p", PUBKEY_HEX]],
      content: ""
    };
    const signed = await window.nostr.signEvent(ev);
    alert("Please confirm the follow in your extension‚Äôs signing popup.");
    console.log("Signed follow event:", signed);
  }catch(e){
    console.error(e);
    alert("Follow request was cancelled or failed.");
  }
}

/* ---------- Boot ---------- */
async function load(){
  try{
    const [profileEv, notes] = await Promise.all([getKind0(PUBKEY_HEX), getKind1(PUBKEY_HEX)]);
    const meta = profileEv ? await getProfile(PUBKEY_HEX) : await getProfile(PUBKEY_HEX);
    applyProfileToBanner(meta);
    await drawFeed(notes);

    const count = await getFollowersCount(PUBKEY_HEX);
    document.getElementById("followersCount").textContent = (count ?? "‚Äî");

    document.getElementById("homeBtn").onclick = async ()=>{
      overlay.classList.remove("hidden");
      const latest = await getKind1(PUBKEY_HEX);
      await drawFeed(latest);
    };
    document.getElementById("aboutBtn").onclick = showAbout;
    document.getElementById("shopBtn").onclick = ()=>{};
    document.getElementById("followBtn").onclick = followViaExtension;
    document.getElementById("zapBtn").onclick = showZapPage;
  }catch(e){
    console.error(e);
    feedEl.innerHTML="<p style='color:#f77;text-align:center;'>Error loading posts.</p>";
  }finally{
    overlay.classList.add("hidden");
  }
}

window.addEventListener("load", load);
</script>
</body>
</html>
